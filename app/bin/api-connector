#!/usr/bin/env ruby
require_relative '../config/defaults'
Thread.abort_on_exception = true
STDOUT.sync = true

first_try = true
begin
  $logger.debug { "Creating mongodb indexes" }
  Mongoid::Tasks::Database::create_indexes
rescue => e
  if first_try
    Mongoid::Tasks::Database::remove_indexes
    retry
  else
    raise e
  end
end


$logger.info 'Initializing Kubernetes Meter Submission Handler'

config = Inventory::load_configuration($logger)

connector = OnPremiseConnector.new(config)

loop {
  connector.sync
  File.write("/tmp/heartbeat", "")  # for kubernetes health check
  sleep 30.seconds }
